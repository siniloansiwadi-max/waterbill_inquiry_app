<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Water Bill Inquiry</title>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>

        /* ====================================================================== */
        /* 1. BASE STYLING - PROFESSIONAL BLUE WITH WHITE BORDERS */
        /* ====================================================================== */
        body { 
            background: linear-gradient(135deg, #1e3c72, #2a5298); /* Professional blue gradient */
            min-height: 100vh; 
            margin: 0;
            padding: 0;
            display: flex; 
            flex-direction: column;
            justify-content: center; 
            align-items: center; 
            font-family: 'Montserrat', sans-serif; 
            color: #333;
            position: relative;
            overflow-x: hidden;
        }

        /* White border effect around the edges */
        body::before {
            content: '';
            position: fixed;
            top: 10px;
            left: 10px;
            right: 10px;
            bottom: 10px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            pointer-events: none;
            z-index: 0;
        }

        /* Subtle grid pattern for professional look */
        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(rgba(255, 255, 255, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.05) 1px, transparent 1px);
            background-size: 40px 40px;
            pointer-events: none;
            z-index: 0;
        }

        /* ====================================================================== */
        /* 2. MAIN CONTAINER STYLING */
        /* ====================================================================== */
        .container {
            background-color: rgba(255, 255, 255, 0.98); 
            padding: 40px 60px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            text-align: center;
            position: relative;
            z-index: 1;
            border: 1px solid rgba(0, 0, 0, 0.1);
            max-width: 600px;
            width: 90%;
        }

        h1 {
            color: #1e3c72; /* Dark blue matching background */
            margin-bottom: 30px;
            margin-top: 0;
            font-size: 2.2rem;
            font-weight: 700;
            position: relative;
            padding-bottom: 15px;
        }

        h1::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 25%;
            right: 25%;
            height: 3px;
            background: linear-gradient(to right, #1e3c72, #2a5298);
            border-radius: 2px;
        }

        /* ====================================================================== */
        /* 3. INPUT AND BUTTON STYLING */
        /* ====================================================================== */
        input, button { 
            padding: 12px 20px;
            margin-right: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            font-family: 'Montserrat', sans-serif;
            transition: all 0.3s ease;
        }

        #accountNumber {
            border: 2px solid #e0e0e0;
            width: 250px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        #accountNumber:focus {
            outline: none;
            border-color: #2a5298;
            box-shadow: 0 0 0 3px rgba(42, 82, 152, 0.1);
        }
        
        button {
            background: linear-gradient(to bottom, #2a5298, #1e3c72);
            color: white;
            cursor: pointer;
            border: none;
            font-weight: 600;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        button:hover {
            background: linear-gradient(to bottom, #1e3c72, #2a5298);
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
        }

        button:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* ====================================================================== */
        /* 4. LOADING ANIMATION */
        /* ====================================================================== */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .spinner {
            border: 4px solid #f3f3f3; 
            border-top: 4px solid #2a5298; 
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 10px;
        }
        #loading-message {
            margin-top: 15px;
            color: #2a5298;
            font-weight: 600;
            display: none; 
        }

        /* ====================================================================== */
        /* 5. LOGO AND INPUT GROUP */
        /* ====================================================================== */
        #input-group {
            display: flex;
            align-items: center; 
            justify-content: center; 
            margin-bottom: 25px; 
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        #site-logo {
            width: 45px; 
            height: 45px;
            margin-right: 15px; 
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        #input-group label {
            margin-right: 10px;
            font-weight: 600;
            color: #495057;
        }

        /* ====================================================================== */
        /* 6. DISCLAIMER STYLING */
        /* ====================================================================== */
        .disclaimer {
            margin-top: 25px;
            padding: 20px;
            background: linear-gradient(to bottom, #f8f9fa, #e9ecef);
            border-left: 5px solid #2a5298;
            border-radius: 8px;
            text-align: left;
            font-size: 0.85rem;
            color: #495057;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
            border-top: 1px solid #dee2e6;
            border-right: 1px solid #dee2e6;
            border-bottom: 1px solid #dee2e6;
        }

        .disclaimer h4 {
            margin-top: 0;
            color: #1e3c72;
            font-size: 1rem;
            margin-bottom: 10px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .disclaimer ul {
            margin: 0;
            padding-left: 20px;
        }

        .disclaimer li {
            margin-bottom: 8px;
            line-height: 1.5;
            position: relative;
        }

        .disclaimer li::before {
            content: "â€¢";
            color: #2a5298;
            font-weight: bold;
            display: inline-block;
            width: 1em;
            margin-left: -1em;
        }

        /* ====================================================================== */
        /* 7. MODAL BOX STYLING */
        /* ====================================================================== */
        #modal-container {
            position: fixed; 
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(30, 60, 114, 0.9); /* Blue overlay */
            display: none; 
            justify-content: center;
            align-items: center;
            z-index: 1000; 
        }

        #modal-content {
            background-color: white;
            padding: 25px; 
            border-radius: 10px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.25);
            max-width: 450px; 
            width: 90%;
            text-align: left;
            font-family: 'Montserrat', sans-serif;
            word-break: break-word;
            overflow-wrap: break-word;
            border: 2px solid #e0e0e0;
        }

        #new-inquiry-button {
            background: linear-gradient(to bottom, #2a5298, #1e3c72);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            float: right;
            margin-top: 15px;
            font-size: 0.9rem;
        }

        #new-inquiry-button:hover {
            background: linear-gradient(to bottom, #1e3c72, #2a5298);
        }
        
        /* ====================================================================== */
        /* 8. VERTICAL GAP FIXES (For clean list display) */
        /* ====================================================================== */
        #modal-content ul {
            margin: 0 !important; 
            padding-left: 0 !important;  
        }

        #modal-content ul li {
            margin: 8px 0 !important; 
            padding: 8px 0 !important; 
            line-height: 1.4;
            border-bottom: 1px solid #f0f0f0;
        }

        #modal-content ul li:last-child {
            border-bottom: none;
        }

        #modal-content ul li strong {
            color: #1e3c72;
            min-width: 160px;
            display: inline-block;
        }
        
        #modal-result h3 {
            margin-top: 0; 
            color: #1e3c72;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
            margin-bottom: 15px;
        }

        /* ====================================================================== */
        /* 9. SERVICES BUTTON STYLING */
        /* ====================================================================== */
        #services-button {
            background: linear-gradient(to bottom, #ffffff, #f8f9fa);
            color: #1e3c72;
            padding: 12px 30px;
            border: 2px solid #2a5298;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-family: 'Montserrat', sans-serif;
            transition: all 0.3s ease;
            margin-top: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        #services-button:hover {
            background: linear-gradient(to bottom, #2a5298, #1e3c72);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
        }

        .new-button-container {
            position: relative;
            z-index: 1;
            margin-top: 25px;
        }

        /* ====================================================================== */
        /* 10. RESPONSIVE DESIGN: MEDIA QUERIES */
        /* ====================================================================== */

        @media (max-width: 768px) { 
            body::before {
                top: 5px;
                left: 5px;
                right: 5px;
                bottom: 5px;
            }

            .container {
                padding: 25px 20px;
                width: 95%;
            }

            h1 {
                font-size: 1.8rem;
                margin-bottom: 20px;
            }

            #input-group {
                flex-direction: column;
                align-items: center; 
                width: 100%;
                padding: 15px;
            }
            
            #site-logo {
                margin: 0 auto 15px auto; 
            }

            #input-group label {
                display: block;
                text-align: center;
                margin-right: 0; 
                margin-bottom: 10px;
            }

            #accountNumber {
                width: 100%;
                box-sizing: border-box; 
                margin-bottom: 15px; 
            }

            button {
                width: 100%;
                margin-right: 0;
            }

            .disclaimer {
                padding: 15px;
                font-size: 0.8rem;
            }

            #modal-content {
                padding: 20px;
                max-width: 90%;
            }

            #services-button {
                width: 100%;
                padding: 12px 20px;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 20px 15px;
            }

            h1 {
                font-size: 1.6rem;
            }

            #accountNumber {
                font-size: 14px;
                padding: 10px 15px;
            }

            button {
                padding: 10px 15px;
                font-size: 14px;
            }
        }
    
    </style>
</head>
<body>

<div class="container">
    <h1>Water Bill Inquiry</h1>
    
    <div id="input-group">
        <img src="siwadilogo.png" alt="Company Logo" id="site-logo">
        
        <label for="accountNumber">Enter Account Number:</label>
        <input type="text" 
               id="accountNumber" 
               placeholder="e.g., 011-101-001 or 011101001"
               autofocus> 
    </div>
    
    <button onclick="fetchAccountData()">Search</button>

    <div id="loading-message">
        <div class="spinner"></div> Please wait...
    </div>
    
    <!-- DISCLAIMER SECTION -->
    <div class="disclaimer">
        <h4>ðŸ”’ Important Disclaimer:</h4>
        <ul>
            <li>This system is for informational purposes only</li>
            <li>Customer names are partially masked for privacy protection</li>
            <li>For official statements, please visit our office</li>
            <li>GCash payment is not real-time; it takes 3 working days for  </li>
            <li>us to update all the payments that are done with GCash.</li>
        </ul>
    </div>
</div>

<div id="modal-container">
    <div id="modal-content">
        <div id="modal-result">
            </div>
        
        <button id="new-inquiry-button" onclick="closeModal()">New Inquiry</button>
    </div>
</div>

<div class="new-button-container">
    <a href="services.html">
        <button id="services-button">Visit our gallery</button>
    </a>
</div>
    
<script>

// ======================================================================
// JAVASCRIPT LOGIC
// ======================================================================

// ---------------------------
// TWO Web App URLs (UPDATED)
// ---------------------------
// DATA_WEB_APP_URL: your existing inquiry script (same as original WEB_APP_URL)
const DATA_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwe0PWj59RsVzeLtdI64AvV8bXi8D9ZMIPOrBgaDzWlYiSU0xARCxp0SK86kkTxAG0T/exec';

// LOG_WEB_APP_URL: replace this placeholder with your activity-log script's web app URL
const LOG_WEB_APP_URL  = 'https://script.google.com/macros/s/AKfycbxQKyzoU1AczxwzSiM24DA7TNRsUmiXocgH-TBY7JoM5Xux9wVNZUWBB6ycD4sr-pBE/exec';

// ðŸŽ¯ DISPLAY MAPPING: (Use your exact sheet headers on the left)
const DISPLAY_MAP = {
    'Account No.': 'Account Number', 
    'Name': 'Name',
    'Address': 'Billing Address', 
    'No.': 'Meter Number',
    'Status for App': 'Account Status',
    'BALANCE': 'Water Bill',
    'AROBALANCE': 'S.C. / Materials', 
    'Total': 'Total Amount Due',  
    'Reading Date': 'Reading Date',       // NEW: Column L        
    'Due Date': 'Payment Due Date',       
    'Reading Date': 'Reading Date',       // NEW: Column L
    'Discon Date': 'Disconnection Date'   // NEW: Column M
};

// Get references to DOM elements
const loadingMessage = document.getElementById('loading-message');
const inputElement = document.getElementById('accountNumber');
const modalContainer = document.getElementById('modal-container');
const modalResult = document.getElementById('modal-result');
const searchButton = document.querySelector('button'); // Reference for disabling

// --- Helper function to close the pop-up ---
function closeModal() {
    modalContainer.style.display = 'none';
    modalResult.innerHTML = ''; 
    inputElement.value = ''; 
    inputElement.focus();
}

// --- Helper function for Name Masking ---
function maskName(fullName) {
    if (!fullName || typeof fullName !== 'string') return '';
    
    const nameParts = fullName.toUpperCase().trim().split(/\s+/);
    
    let maskedParts = nameParts.map((part, index) => {
        if (part.length === 0) return '';
        
        if (index === 0) {
            // First Name: JUAN -> JU**
            const visiblePart = part.substring(0, 2);
            const maskedPart = part.substring(2).replace(/[A-Z]/g, '*');
            return visiblePart + maskedPart;
        } else {
            // Last Names: DELA -> D***
            const visiblePart = part.substring(0, 1);
            const maskedPart = part.substring(1).replace(/[A-Z]/g, '*');
            return visiblePart + maskedPart;
        }
    });

    return maskedParts.join(' ');
}



// --- Formatter Function (The final, robust version) ---
function formatResult(data) {
    let output = '<ul style="list-style-type: none;">'; 
    
    for (const sheetHeader in DISPLAY_MAP) {
        if (data.hasOwnProperty(sheetHeader)) {
            let value = String(data[sheetHeader]).replace(/"/g, ''); 
            const displayLabel = DISPLAY_MAP[sheetHeader];

            // 1. Check if the field is the Name field to apply masking
            if (displayLabel.toUpperCase() === 'NAME' || 
                displayLabel.toUpperCase() === 'CUSTOMER NAME') {
                
                value = maskName(value);
            }
            
            // 2. Apply Date Formatting
            if (displayLabel.includes('Date') && value) { 
                const dateObj = new Date(value); 
                if (!isNaN(dateObj.getTime())) { 
                    const month = String(dateObj.getMonth() + 1).padStart(2, '0');
                    const day = String(dateObj.getDate()).padStart(2, '0');
                    const year = String(dateObj.getFullYear()).slice(-2);
                    value = `${month}-${day}-${year}`;
                }
            }
            
            // 3. Apply Currency Formatting
            if (displayLabel.includes('Charge') || displayLabel.includes('Amount')) {
                 value = `â‚± ${parseFloat(value).toFixed(2)}`;
            }

            // 4. Append the list item
            output += `
                <li>
                    <strong style="color: #1e3c72;">${displayLabel}:</strong> ${value}
                </li>
            `;
        }
    }
    output += '</ul>';
    return output;
}


// --- Main Fetch Function ---
async function fetchAccountData() {
    
    let rawAccountNumber = inputElement.value.trim();
    const searchKey = rawAccountNumber.replace(/[\s\-\â€“]/g, ''); 
    
    if (!searchKey) {
        alert("Please enter an account number.");
        return;
    }
    
    // Hide old result and disable button to prevent double clicks
    modalContainer.style.display = 'none'; 
    loadingMessage.style.display = 'block';
    searchButton.disabled = true; 

    // <-- use DATA_WEB_APP_URL for fetching data
    const apiUrl = `${DATA_WEB_APP_URL}?account=${searchKey}`;

    try {
        const response = await fetch(apiUrl);
        const data = await response.json();

        let resultTitle = `Results for Account: ${rawAccountNumber}`;
        let resultHtml = '';

        if (data.error) {
            resultTitle = `Search Failed for ${rawAccountNumber}`;
            resultHtml = `<p style="color: red; font-weight: bold;">Error: ${data.error}</p>`;
        } else {
            resultHtml = formatResult(data); 

            // -----------------------------
            // CALL ACTIVITY LOG (non-blocking)
            // -----------------------------
            // only if account and name exist in response
            try {
                if (data['Account No.'] && data['Name']) {
                    logInquiry(data['Account No.'], data['Name']);
                }
            } catch (xx) {
                // keep UI robust â€” don't break on logging errors
                console.error('logInquiry error', xx);
            }
        }

        // Inject content and show modal
        modalResult.innerHTML = `
            <h3 style="color: #1e3c72;">${resultTitle}</h3>
            <div style="border: 1px solid #e0e0e0; padding: 15px; background-color: #f9f9f9; border-radius: 8px;">
                ${resultHtml}
            </div>
        `;
        modalContainer.style.display = 'flex'; 

    } catch (error) {
        if (modalContainer) {
             modalResult.innerHTML = `<h3>Network Error</h3><p>Could not connect to the API. Check console for details.</p>`;
             modalContainer.style.display = 'flex';
        }
        console.error('Fetch error:', error);
    } finally {
        loadingMessage.style.display = 'none';
        searchButton.disabled = false; // Re-enable button
    }
}


// ------------------------------------------------------------------
// logInquiry: sends account, name and timestamp to your LOG_WEB_APP_URL
// ------------------------------------------------------------------
async function logInquiry(accountNo, name) {
    if (!LOG_WEB_APP_URL || LOG_WEB_APP_URL.indexOf('PASTE_YOUR_LOG_SCRIPT_URL_HERE') !== -1) {
        // placeholder not replaced â€” skip logging to avoid accidental requests
        console.warn('LOG_WEB_APP_URL not configured. Replace the placeholder with your log script URL.');
        return;
    }
    try {
        const params = new URLSearchParams({
            account: accountNo,
            name: name,
            timestamp: new Date().toISOString()
        });
        // fire-and-forget log call
        await fetch(`${LOG_WEB_APP_URL}?${params.toString()}`, { method: 'GET', mode: 'no-cors' });
        console.log('Inquiry logged:', accountNo, name);
    } catch (err) {
        // don't disturb the user flow for logging errors
        console.error('Failed to log inquiry:', err);
    }
}
</script>

</body>
</html>
