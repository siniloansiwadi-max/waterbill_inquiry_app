<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Water Bill Inquiry</title>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
    
    <style>

        /* ====================================================================== */
        /* ❄️ FALLING SNOW STYLING - ADD THIS TO EXISTING CSS */
        /* ====================================================================== */
        #snow {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }

        .snowflake {
            position: absolute;
            background: white;
            border-radius: 50%;
            opacity: 0.8;
            animation: fall linear infinite;
        }

        @keyframes fall {
            to {
                transform: translateY(100vh) rotate(360deg);
            }
        }

        /* ====================================================================== */
        /* 1. BASE STYLING, GRADIENT, AND CENTERING */
        /* ====================================================================== */
        body { 
            background: linear-gradient(135deg, #00BFFF, #FFD700); 
            min-height: 100vh; 
            margin: 0;
            padding: 0;
            display: flex; 
            flex-direction: column;
            justify-content: center; 
            align-items: center; 
            font-family: 'Montserrat', sans-serif; 
            color: #333; 
        }
        
        .container {
            /* Main input box container */
            background-color: rgba(255, 255, 255, 0.95); 
            padding: 40px 60px;
            border-radius: 10px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
            text-align: center;
        }

        h1 {
            color: #007bff;
            margin-bottom: 25px;
        }

        input, button { 
            padding: 12px 20px;
            margin-right: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 16px;
            font-family: 'Montserrat', sans-serif;
        }
        
        button {
            background-color: #007bff;
            color: white;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: #0056b3;
        }

        /* Loading Animation */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .spinner {
            border: 4px solid #f3f3f3; 
            border-top: 4px solid #007bff; 
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 10px;
        }
        #loading-message {
            margin-top: 15px;
            color: #007bff;
            font-weight: bold;
            display: none; 
        }

        /* --- LOGO AND INPUT ALIGNMENT --- */
        #input-group {
            display: flex;
            align-items: center; 
            justify-content: center; 
            margin-bottom: 20px; 
        }

        #site-logo {
            width: 40px; 
            height: 40px;
            margin-right: 15px; 
            vertical-align: middle; 
        }

        #input-group label {
            margin-right: 10px;
        }

        /* ====================================================================== */
        /* 2. MODAL BOX AND POP-UP STYLING */
        /* ====================================================================== */
        #modal-container {
            position: fixed; 
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7); 
            display: none; 
            justify-content: center;
            align-items: center;
            z-index: 1000; 
        }

        #modal-content {
            background-color: white;
            padding: 20px; 
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            max-width: 400px; 
            width: 90%;
            text-align: left;
            font-family: 'Montserrat', sans-serif;
            /* Added for address wrapping */
            word-break: break-word;
            overflow-wrap: break-word;
        }

        #new-inquiry-button {
            background-color: #FFD700;
            color: #333;
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            float: right;
            margin-top: 15px;
        }
        
        /* ====================================================================== */
        /* 3. VERTICAL GAP FIXES (For clean list display) */
        /* ====================================================================== */
        #modal-content ul {
            margin: 0 !important; 
            padding-left: 0 !important;  
        }

        #modal-content ul li {
            margin: 0 !important; 
            padding: 0 !important; 
            line-height: 1.1; /* Tightens the line height */
        }
        
        #modal-result h3 {
            margin-top: 0; 
        }

        /* ====================================================================== */
        /* 4. RESPONSIVE DESIGN: MEDIA QUERIES */
        /* ====================================================================== */

        @media (max-width: 768px) { 
            .container {
                padding: 30px 20px;
            }

            #input-group {
                /* Stack elements vertically on small screens */
                flex-direction: column;
                align-items: center; 
                width: 100%;
            }
            
            #site-logo {
                margin: 0 auto 10px auto; 
            }

            #input-group label {
                display: block;
                text-align: center;
                margin-right: 0; 
                margin-bottom: 5px;
            }

            #accountNumber {
                width: 100%;
                box-sizing: border-box; 
                margin-bottom: 15px; 
            }

            button {
                width: 100%;
                margin-right: 0;
            }
        }

    /* --- Styling for the New Services Button --- */
    #services-button {
    /* Base color matching your scheme */
    background-color: #FFD700; 
    color: #333; /* Dark text for contrast */
    padding: 12px 25px;
    border: 2px solid #e0c800; /* Subtle border */
    border-radius: 5px;
    cursor: pointer;
    font-weight: bold;
    font-family: 'Montserrat', sans-serif;
    transition: background-color 0.3s;
    }

    #services-button:hover {
    background-color: #e0c800;
    }
    
    </style>
</head>
<body>

<!-- ❄️ FALLING SNOW - ADD THIS LINE -->
<div id="snow"></div>

<div class="container">
    <h1>Water Bill Inquiry</h1>
    
    <div id="input-group">
        <img src="siwadilogo.png" alt="Company Logo" id="site-logo">
        
        <label for="accountNumber">Enter Account Number:</label>
        <input type="text" 
               id="accountNumber" 
               placeholder="e.g., 011-101-001 or 011101001"
               autofocus> 
    </div>
    
    <button onclick="fetchAccountData()">Search</button>

    <div id="loading-message">
        <div class="spinner"></div> Please wait...
    </div>
    
    <div id="session-inquiry-count" style="margin-top: 20px; font-weight: bold; color: #555;">
        Inquiries this Session: 0
    </div>
</div>

<div id="modal-container">
    <div id="modal-content">
        <div id="modal-result">
            </div>
        
        <button id="new-inquiry-button" onclick="closeModal()">New Inquiry</button>
    </div>
</div>

</div> 
<div class="new-button-container" style="margin-top: 25px;">
    <a href="services.html">
        <button id="services-button">Other Services</button>
    </a>
</div>
    
<script>

// ======================================================================
// ❄️ FALLING SNOW FUNCTIONALITY
// ======================================================================
function createSnow() {
    const snowContainer = document.getElementById('snow');
    if (!snowContainer) return;
    
    const snowflakes = 80; // Number of snowflakes
    
    for (let i = 0; i < snowflakes; i++) {
        const snowflake = document.createElement('div');
        snowflake.classList.add('snowflake');
        
        // Random properties for each snowflake
        const size = Math.random() * 5 + 2;
        const left = Math.random() * 100;
        const animationDuration = Math.random() * 5 + 5;
        const animationDelay = Math.random() * 5;
        
        snowflake.style.width = `${size}px`;
        snowflake.style.height = `${size}px`;
        snowflake.style.left = `${left}vw`;
        snowflake.style.animationDuration = `${animationDuration}s`;
        snowflake.style.animationDelay = `${animationDelay}s`;
        
        snowContainer.appendChild(snowflake);
    }
}

// Start snow when page loads
window.addEventListener('load', createSnow);

// ======================================================================
// JAVASCRIPT LOGIC
// ======================================================================

// 1. GLOBAL VARIABLE: Initial counter that tracks searches in the current session.
let sessionCounter = 0; 

// ---------------------------
// TWO Web App URLs (UPDATED)
// ---------------------------
// DATA_WEB_APP_URL: your existing inquiry script (same as original WEB_APP_URL)
const DATA_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxqw1ujDkYy5rzDQc_sITyVdB5D4TVPJE7DLs1oQhQmOp2VE_MAXnf4x6f_WgKrxqwO/exec';

// LOG_WEB_APP_URL: replace this placeholder with your activity-log script's web app URL
const LOG_WEB_APP_URL  = 'https://script.google.com/macros/s/AKfycbxQKyzoU1AczxwzSiM24DA7TNRsUmiXocgH-TBY7JoM5Xux9wVNZUWBB6ycD4sr-pBE/exec';

// 🎯 DISPLAY MAPPING: (Use your exact sheet headers on the left)
const DISPLAY_MAP = {
    'Account No.': 'Account Number', 
    'Name': 'Name',
    'Address': 'Billing Address', 
    'No.': 'Meter Number',  
    'BALANCE': 'Water Bill',
    'AROBALANCE': 'S.C. / Materials', 
    'Total': 'Total Amount Due',          
    'Due Date': 'Payment Due Date',       
    'Status for App': 'Account Status'            
};

// Get references to DOM elements
const loadingMessage = document.getElementById('loading-message');
const inputElement = document.getElementById('accountNumber');
const modalContainer = document.getElementById('modal-container');
const modalResult = document.getElementById('modal-result');
const counterElement = document.getElementById('session-inquiry-count');
const searchButton = document.querySelector('button'); // Reference for disabling

// --- Helper function to close the pop-up ---
function closeModal() {
    modalContainer.style.display = 'none';
    modalResult.innerHTML = ''; 
    inputElement.value = ''; 
    inputElement.focus();
}

// --- Helper function for Name Masking ---
function maskName(fullName) {
    if (!fullName || typeof fullName !== 'string') return '';
    
    const nameParts = fullName.toUpperCase().trim().split(/\s+/);
    
    let maskedParts = nameParts.map((part, index) => {
        if (part.length === 0) return '';
        
        if (index === 0) {
            // First Name: JUAN -> JU**
            const visiblePart = part.substring(0, 2);
            const maskedPart = part.substring(2).replace(/[A-Z]/g, '*');
            return visiblePart + maskedPart;
        } else {
            // Last Names: DELA -> D***
            const visiblePart = part.substring(0, 1);
            const maskedPart = part.substring(1).replace(/[A-Z]/g, '*');
            return visiblePart + maskedPart;
        }
    });

    return maskedParts.join(' ');
}



// --- Formatter Function (The final, robust version) ---
function formatResult(data) {
    let output = '<ul style="list-style-type: none;">'; 
    
    for (const sheetHeader in DISPLAY_MAP) {
        if (data.hasOwnProperty(sheetHeader)) {
            let value = String(data[sheetHeader]).replace(/"/g, ''); 
            const displayLabel = DISPLAY_MAP[sheetHeader];

            // 1. Check if the field is the Name field to apply masking
            if (displayLabel.toUpperCase() === 'NAME' || 
                displayLabel.toUpperCase() === 'CUSTOMER NAME') {
                
                value = maskName(value);
            }
            
            // 2. Apply Date Formatting
            if (displayLabel.includes('Date') && value) { 
                const dateObj = new Date(value); 
                if (!isNaN(dateObj.getTime())) { 
                    const month = String(dateObj.getMonth() + 1).padStart(2, '0');
                    const day = String(dateObj.getDate()).padStart(2, '0');
                    const year = String(dateObj.getFullYear()).slice(-2);
                    value = `${month}-${day}-${year}`;
                }
            }
            
            // 3. Apply Currency Formatting
            if (displayLabel.includes('Charge') || displayLabel.includes('Amount')) {
                 value = `₱ ${parseFloat(value).toFixed(2)}`;
            }

            // 4. Append the list item
            output += `
                <li>
                    <strong style="color: #007bff;">${displayLabel}:</strong> ${value}
                </li>
            `;
        }
    }
    output += '</ul>';
    return output;
}


// --- Main Fetch Function ---
async function fetchAccountData() {
    
    let rawAccountNumber = inputElement.value.trim();
    const searchKey = rawAccountNumber.replace(/[\s\-\–]/g, ''); 
    
    if (!searchKey) {
        alert("Please enter an account number.");
        return;
    }
    
    // Hide old result and disable button to prevent double clicks
    modalContainer.style.display = 'none'; 
    loadingMessage.style.display = 'block';
    searchButton.disabled = true; 

    // <-- use DATA_WEB_APP_URL for fetching data
    const apiUrl = `${DATA_WEB_APP_URL}?account=${searchKey}`;

    try {
        const response = await fetch(apiUrl);
        const data = await response.json();

        let resultTitle = `Results for Account: ${rawAccountNumber}`;
        let resultHtml = '';

        if (data.error) {
            resultTitle = `Search Failed for ${rawAccountNumber}`;
            resultHtml = `<p style="color: red; font-weight: bold;">Error: ${data.error}</p>`;
        } else {
            // SUCCESS: Increment and update session counter
            sessionCounter++;
            counterElement.textContent = `Inquiries this Session: ${sessionCounter}`;
            
            resultHtml = formatResult(data); 

            // -----------------------------
            // CALL ACTIVITY LOG (non-blocking)
            // -----------------------------
            // only if account and name exist in response
            try {
                if (data['Account No.'] && data['Name']) {
                    logInquiry(data['Account No.'], data['Name']);
                }
            } catch (xx) {
                // keep UI robust — don't break on logging errors
                console.error('logInquiry error', xx);
            }
        }

        // Inject content and show modal
        modalResult.innerHTML = `
            <h3 style="color: #333;">${resultTitle}</h3>
            <div style="border: 1px solid #ccc; padding: 10px; background-color: #f7f7f7; border-radius: 5px;">
                ${resultHtml}
            </div>
        `;
        modalContainer.style.display = 'flex'; 

    } catch (error) {
        if (modalContainer) {
             modalResult.innerHTML = `<h3>Network Error</h3><p>Could not connect to the API. Check console for details.</p>`;
             modalContainer.style.display = 'flex';
        }
        console.error('Fetch error:', error);
    } finally {
        loadingMessage.style.display = 'none';
        searchButton.disabled = false; // Re-enable button
    }
}


// ------------------------------------------------------------------
// logInquiry: sends account, name and timestamp to your LOG_WEB_APP_URL
// ------------------------------------------------------------------
async function logInquiry(accountNo, name) {
    if (!LOG_WEB_APP_URL || LOG_WEB_APP_URL.indexOf('PASTE_YOUR_LOG_SCRIPT_URL_HERE') !== -1) {
        // placeholder not replaced — skip logging to avoid accidental requests
        console.warn('LOG_WEB_APP_URL not configured. Replace the placeholder with your log script URL.');
        return;
    }
    try {
        const params = new URLSearchParams({
            account: accountNo,
            name: name,
            timestamp: new Date().toISOString()
        });
        // fire-and-forget log call
        await fetch(`${LOG_WEB_APP_URL}?${params.toString()}`, { method: 'GET', mode: 'no-cors' });
        console.log('Inquiry logged:', accountNo, name);
    } catch (err) {
        // don't disturb the user flow for logging errors
        console.error('Failed to log inquiry:', err);
    }
}
</script>

</body>
</html>

